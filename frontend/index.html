<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WHIST</title>
  <style>
    /* â”€â”€ Flexoki variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:        #100F0F;
      --surface:   #1C1B1A;
      --surface-2: #282726;
      --border:    #403E3C;
      --muted:     #575653;
      --tx-dim:    #878580;
      --tx:        #CECDC3;
      --red:    #AF3029;
      --orange: #CB7A29;
      --yellow: #D0A215;
      --green:  #66800B;
      --cyan:   #24837B;
      --blue:   #205EA6;
      --purple: #5E409D;
      --accent: var(--red);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:        #FFFCF0;
        --surface:   #F2F0E5;
        --surface-2: #E6E4D9;
        --border:    #CECDC3;
        --muted:     #B7B5AC;
        --tx-dim:    #6F6E69;
        --tx:        #100F0F;
        --red:    #AF3029;
        --orange: #AD5700;
        --yellow: #AD8301;
        --green:  #66800B;
        --cyan:   #24837B;
        --blue:   #205EA6;
        --purple: #5E409D;
      }
    }

    /* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; scroll-behavior: smooth; }
    body {
      min-height: 100%;
      background: var(--bg);
      color: var(--tx);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 15px;
      line-height: 1.5;
    }
    a { color: inherit; text-decoration: none; }
    img { display: block; }
    button { cursor: pointer; border: none; background: none; font: inherit; color: inherit; }
    input { font: inherit; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #top-nav { position: sticky; top: 0; z-index: 50; }
    #app { min-height: calc(100vh - 56px); }
    #bottom-nav { display: none; }

    /* â”€â”€ Top nav bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .nav-bar {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0 1.5rem;
      height: 56px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .nav-logo {
      font-weight: 800;
      font-size: 1.05rem;
      letter-spacing: 0.12em;
      color: var(--red);
    }
    .nav-links { display: flex; gap: 0.25rem; }
    .nav-link {
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      color: var(--tx-dim);
      font-size: 0.9rem;
      transition: color 0.1s, background 0.1s;
    }
    .nav-link:hover { background: var(--surface-2); color: var(--tx); }
    .nav-link.active { color: var(--accent); background: color-mix(in srgb, var(--accent) 12%, transparent); }
    .nav-spacer { flex: 1; }
    .nav-icon {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 8px;
      color: var(--tx-dim);
      font-size: 1.1rem;
      transition: background 0.1s, color 0.1s;
    }
    .nav-icon:hover { background: var(--surface-2); color: var(--tx); }

    /* â”€â”€ Bottom nav (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 58px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 50;
    }
    .bottom-nav-item {
      flex: 1;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 2px;
      color: var(--tx-dim);
      font-size: 10px;
      padding: 6px 0;
      transition: color 0.1s;
    }
    .bottom-nav-item .bn-icon { font-size: 1.2rem; line-height: 1; }
    .bottom-nav-item.active { color: var(--accent); }

    /* â”€â”€ Page container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
    .page-header { margin-bottom: 2rem; }
    .page-header h1 { font-size: 1.75rem; font-weight: 700; color: var(--accent); }
    .page-header p { color: var(--tx-dim); margin-top: 0.2rem; }

    /* â”€â”€ Breadcrumb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .breadcrumb {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.8rem; color: var(--tx-dim);
      margin-bottom: 1.25rem;
    }
    .breadcrumb a:hover { color: var(--accent); }
    .breadcrumb-sep { opacity: 0.4; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.45rem 1.1rem;
      border-radius: 8px;
      font-size: 0.875rem; font-weight: 500;
      transition: opacity 0.1s, background 0.1s;
    }
    .btn-accent { background: var(--accent); color: #fff; border: none; }
    .btn-accent:hover { opacity: 0.88; }
    .btn-outline { background: transparent; border: 1.5px solid var(--accent); color: var(--accent); }
    .btn-outline:hover { background: color-mix(in srgb, var(--accent) 10%, transparent); }
    .btn-ghost { background: var(--surface-2); color: var(--tx-dim); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--border); }
    .btn-sm { padding: 0.25rem 0.625rem; font-size: 0.78rem; }

    /* â”€â”€ Poster grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .poster-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }
    .poster-card { cursor: pointer; }
    .poster-card img {
      width: 100%; aspect-ratio: 2/3;
      object-fit: cover;
      border-radius: 8px;
      background: var(--surface-2);
    }
    .poster-placeholder {
      width: 100%; aspect-ratio: 2/3;
      background: var(--surface-2);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 0.7rem; text-align: center;
      padding: 0.5rem;
    }
    .poster-card .card-title {
      font-size: 0.78rem; margin-top: 0.4rem;
      color: var(--tx);
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    }
    .card-progress {
      height: 3px; border-radius: 2px;
      background: var(--border);
      margin-top: 0.3rem; overflow: hidden;
    }
    .card-progress-fill { height: 100%; background: var(--accent); }

    /* â”€â”€ Section header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section { margin-bottom: 2.5rem; }
    .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .section-header h2 { font-size: 1.05rem; font-weight: 600; }
    .section-count {
      background: var(--surface-2); color: var(--tx-dim);
      border-radius: 10px; padding: 0.1rem 0.45rem; font-size: 0.72rem;
    }

    /* â”€â”€ Show detail header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .show-backdrop {
      width: 100%; aspect-ratio: 16/9; max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      background: var(--surface-2);
      margin-bottom: 1.25rem;
    }
    .show-hero { display: flex; gap: 1.5rem; align-items: flex-start; }
    .show-poster {
      width: 110px; flex-shrink: 0;
      border-radius: 8px; aspect-ratio: 2/3;
      object-fit: cover; background: var(--surface-2);
    }
    .show-info { flex: 1; min-width: 0; }
    .show-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.2rem; }
    .show-meta { color: var(--tx-dim); font-size: 0.82rem; margin-bottom: 0.75rem; }
    .show-overview { color: var(--tx-dim); font-size: 0.875rem; line-height: 1.65; margin-top: 0.75rem; }

    /* â”€â”€ Status selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-selector { display: flex; gap: 0.375rem; flex-wrap: wrap; margin: 0.75rem 0; }
    .status-btn {
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      color: var(--tx-dim); font-size: 0.78rem;
      transition: all 0.12s;
    }
    .status-btn:hover { border-color: var(--accent); color: var(--accent); }
    .status-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 500; }

    /* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-row { font-size: 0.78rem; color: var(--tx-dim); margin: 0.5rem 0 0.25rem; }
    .progress-bar { height: 4px; border-radius: 2px; background: var(--border); overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); }

    /* â”€â”€ Watch providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .provider-row { display: flex; gap: 1.25rem; flex-wrap: wrap; margin: 0.75rem 0; }
    .provider-group { display: flex; align-items: center; gap: 0.5rem; }
    .provider-label { font-size: 0.7rem; color: var(--tx-dim); text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .provider-logos { display: flex; gap: 0.375rem; flex-wrap: wrap; align-items: center; }
    .provider-logo {
      width: 32px; height: 32px;
      border-radius: 7px; overflow: hidden;
      background: var(--surface-2);
      display: flex; align-items: center; justify-content: center;
      opacity: 0.55; font-size: 0.65rem; font-weight: 600; color: var(--tx-dim);
      transition: opacity 0.15s;
    }
    .provider-logo img { width: 100%; height: 100%; object-fit: cover; }
    .provider-logo.provider-pref { opacity: 1; box-shadow: 0 0 0 2px var(--accent); }
    .provider-logo:hover { opacity: 1; }
    /* "others" toggle button */
    .provider-toggle {
      height: 32px; min-width: 28px; padding: 0 7px;
      border-radius: 7px;
      background: var(--surface-2); color: var(--tx-dim);
      font-size: 0.68rem; font-weight: 600;
      border: 1px solid var(--border); cursor: pointer;
      align-self: center;
      transition: background 0.1s, color 0.1s;
    }
    .provider-toggle:hover { background: var(--border); color: var(--tx); }
    /* hidden overflow span â€” display:contents makes children join the flex row */
    .provider-overflow { display: none; gap: 0.375rem; }
    .provider-overflow.open { display: contents; }

    /* â”€â”€ Schedule card provider logos (compact, preferred-only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sched-providers { display: flex; gap: 0.25rem; flex-wrap: wrap; margin-top: 0.25rem; }
    .sched-providers .provider-logo { width: 22px; height: 22px; border-radius: 5px; }

    /* â”€â”€ Season list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .season-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .season-row {
      display: flex; align-items: center; gap: 1rem;
      padding: 0.875rem 1rem;
      background: var(--surface); border-radius: 10px;
      cursor: pointer; color: var(--tx);
      transition: background 0.1s;
    }
    .season-row:hover { background: var(--surface-2); }
    .season-thumb {
      width: 46px; height: 70px;
      object-fit: cover; border-radius: 5px;
      background: var(--surface-2); flex-shrink: 0;
    }
    .season-thumb-placeholder {
      width: 46px; height: 70px;
      background: var(--surface-2); border-radius: 5px;
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 0.7rem; font-weight: 600;
      flex-shrink: 0;
    }
    .season-info { flex: 1; min-width: 0; }
    .season-name { font-weight: 500; font-size: 0.9rem; }
    .season-meta { font-size: 0.78rem; color: var(--tx-dim); margin: 0.2rem 0 0.4rem; }
    /* Segmented episode bar â€” no gap, container clips rounded corners */
    .seg-bar { display: flex; gap: 0; height: 3px; border-radius: 2px; overflow: hidden; }
    .seg-bar .seg { flex: 1; min-width: 1px; height: 100%; background: var(--border); }
    .seg-bar .seg.w { background: var(--accent); }
    .season-chevron { color: var(--tx-dim); font-size: 1.1rem; }

    /* â”€â”€ Cast grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cast-section { margin-top: 0.5rem; }
    .cast-section-label { font-size: 0.78rem; font-weight: 600; color: var(--tx-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.625rem; }
    .cast-grid {
      display: flex; gap: 0.875rem;
      overflow-x: auto; padding-bottom: 0.5rem;
    }
    .cast-grid::-webkit-scrollbar { height: 4px; }
    .cast-grid::-webkit-scrollbar-track { background: transparent; }
    .cast-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .cast-item { flex-shrink: 0; width: 76px; cursor: pointer; padding-top: 7px; }
    .cast-photo-wrap { position: relative; }
    .cast-photo {
      width: 76px; height: 76px;
      object-fit: cover;
      border-radius: 18%;
      background: var(--surface-2);
      display: block;
    }
    .cast-photo-placeholder {
      width: 76px; height: 76px;
      border-radius: 18%;
      background: var(--surface-2);
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 1.25rem;
    }
    .cast-badge {
      position: absolute; top: -5px; right: -5px;
      min-width: 22px; height: 22px;
      border-radius: 11px;
      background: var(--accent); color: #fff;
      font-size: 0.7rem; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      padding: 0 5px;
      border: 2.5px solid var(--bg);
      pointer-events: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
    .cast-name { font-size: 0.68rem; color: var(--tx); margin-top: 0.35rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .cast-char { font-size: 0.62rem; color: var(--tx-dim); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .cast-see-more {
      flex-shrink: 0; width: 76px;
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 0.72rem; text-align: center;
      cursor: pointer;
    }
    .cast-see-more:hover { color: var(--accent); }

    /* â”€â”€ Schedule cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .schedule-section { margin-bottom: 2rem; }
    .schedule-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .schedule-card {
      display: flex; gap: 0.875rem; align-items: center;
      padding: 0.625rem 0.75rem;
      background: var(--surface); border-radius: 10px;
      cursor: pointer; transition: background 0.1s;
    }
    .schedule-card:hover { background: var(--surface-2); }
    .sched-poster {
      width: 52px; height: 78px;
      object-fit: cover; border-radius: 6px;
      background: var(--surface-2); flex-shrink: 0;
    }
    .sched-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.2rem; }
    .sched-title-row { display: flex; align-items: center; gap: 0.5rem; }
    .sched-title { font-weight: 500; font-size: 0.9rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 1; min-width: 0; }
    .sched-ep { font-size: 0.78rem; color: var(--tx-dim); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .sched-date { font-size: 0.72rem; color: var(--tx-dim); }
    .sched-new-badge {
      flex-shrink: 0;
      background: var(--orange); color: #fff;
      border-radius: 10px; padding: 0.1rem 0.45rem;
      font-size: 0.65rem; font-weight: 700;
    }

    /* â”€â”€ Episode list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .episode-list { display: flex; flex-direction: column; }
    .episode-row {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.6rem 0.5rem;
      border-bottom: 1px solid var(--surface-2);
      transition: background 0.08s;
    }
    .episode-row:hover { background: var(--surface); border-radius: 6px; }
    .ep-check {
      width: 22px; height: 22px; flex-shrink: 0;
      border-radius: 6px;
      border: 1.5px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 0.7rem;
      transition: background 0.1s, border-color 0.1s;
    }
    .ep-check:hover { border-color: var(--accent); }
    .ep-check.watched { background: var(--accent); border-color: var(--accent); color: #fff; }
    .ep-info { flex: 1; min-width: 0; cursor: pointer; }
    .ep-code { font-size: 0.7rem; color: var(--tx-dim); font-variant-numeric: tabular-nums; }
    .ep-title { font-size: 0.875rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .ep-air-date { font-size: 0.72rem; color: var(--tx-dim); flex-shrink: 0; }
    .ep-watched-at { font-size: 0.72rem; color: var(--accent); flex-shrink: 0; }
    .ep-edit-btn {
      flex-shrink: 0; width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px; color: var(--tx-dim); font-size: 0.75rem;
      opacity: 0; transition: opacity 0.1s, background 0.1s;
    }
    .episode-row:hover .ep-edit-btn { opacity: 1; }
    .ep-edit-btn:hover { background: var(--surface-2); color: var(--tx); }

    /* â”€â”€ Episode detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ep-still {
      width: 100%; border-radius: 10px;
      background: var(--surface-2); margin-bottom: 1.5rem;
    }
    .ep-watch-row {
      display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* â”€â”€ Add banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-banner {
      background: color-mix(in srgb, var(--accent) 10%, var(--surface));
      border: 1.5px solid var(--accent);
      border-radius: 10px; padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }
    .add-banner h3 { color: var(--accent); margin-bottom: 0.25rem; }
    .add-banner p { font-size: 0.85rem; color: var(--tx-dim); }
    .add-status-row { display: flex; gap: 0.375rem; flex-wrap: wrap; margin: 0.75rem 0; }
    .add-status-opt {
      padding: 0.25rem 0.7rem;
      border-radius: 16px; border: 1px solid var(--border);
      font-size: 0.78rem; color: var(--tx-dim); cursor: pointer;
      transition: all 0.1s;
    }
    .add-status-opt:hover { border-color: var(--accent); color: var(--accent); }
    .add-status-opt.selected { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 12%, transparent); color: var(--accent); }

    /* â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-input {
      width: 100%; padding: 0.75rem 1rem;
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: 10px; color: var(--tx); font-size: 1rem; outline: none;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-results { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1.25rem; }
    .search-result {
      display: flex; gap: 0.875rem; align-items: center;
      padding: 0.75rem; background: var(--surface); border-radius: 10px;
      cursor: pointer; transition: background 0.1s;
    }
    .search-result:hover { background: var(--surface-2); }
    .search-result-poster {
      width: 42px; height: 63px;
      object-fit: cover; border-radius: 4px;
      background: var(--surface-2); flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-title { font-weight: 500; }
    .search-result-meta { font-size: 0.78rem; color: var(--tx-dim); }
    .search-result-overview {
      font-size: 0.75rem; color: var(--tx-dim);
      overflow: hidden; display: -webkit-box;
      -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }
    .search-tracked { background: var(--accent); color: #fff; border-radius: 4px; padding: 2px 6px; font-size: 0.68rem; flex-shrink: 0; }

    /* â”€â”€ Person page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .person-hero { display: flex; gap: 1.5rem; align-items: flex-start; margin-bottom: 2rem; }
    .person-photo {
      width: 110px; height: 110px; flex-shrink: 0;
      object-fit: cover; border-radius: 18%;
      background: var(--surface-2);
    }
    .person-photo-placeholder {
      width: 110px; height: 110px; flex-shrink: 0;
      border-radius: 18%; background: var(--surface-2);
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 2rem;
    }
    .person-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .seen-in-section {
      background: color-mix(in srgb, var(--purple) 10%, var(--surface));
      border: 1px solid color-mix(in srgb, var(--purple) 25%, var(--border));
      border-radius: 10px; padding: 1rem 1rem 1.25rem;
      margin-bottom: 2rem;
    }
    .seen-in-label { color: var(--purple); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.875rem; }
    .seen-in-grid {
      display: flex; gap: 0.875rem;
      overflow-x: auto; padding-bottom: 0.25rem;
    }
    .seen-in-card { flex-shrink: 0; width: 88px; cursor: pointer; }
    .seen-in-card img {
      width: 88px; height: 132px;
      object-fit: cover; border-radius: 6px;
      background: var(--surface-2);
    }
    .seen-in-card-placeholder {
      width: 88px; height: 132px;
      background: var(--surface-2); border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      color: var(--tx-dim); font-size: 0.65rem; text-align: center; padding: 4px;
    }
    .seen-in-title { font-size: 0.7rem; color: var(--tx); margin-top: 0.35rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .seen-in-char { font-size: 0.65rem; color: var(--tx-dim); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .credits-list { display: flex; flex-direction: column; gap: 0.375rem; }
    .credit-row {
      display: flex; align-items: center; gap: 0.875rem;
      padding: 0.625rem; background: var(--surface); border-radius: 8px;
      cursor: pointer; transition: background 0.1s;
    }
    .credit-row:hover { background: var(--surface-2); }
    .credit-poster {
      width: 34px; height: 51px;
      object-fit: cover; border-radius: 4px;
      background: var(--surface-2); flex-shrink: 0;
    }
    .credit-poster-ph {
      width: 34px; height: 51px;
      background: var(--surface-2); border-radius: 4px; flex-shrink: 0;
    }
    .credit-info { flex: 1; min-width: 0; }
    .credit-title { font-size: 0.875rem; font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .credit-char { font-size: 0.72rem; color: var(--tx-dim); }
    .credit-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--purple); flex-shrink: 0; }

    /* â”€â”€ Date picker popover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .popover-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      padding: 1rem;
    }
    .popover {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px; padding: 1.25rem;
      min-width: 250px; max-width: 320px; width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    }
    .popover h3 { font-size: 0.95rem; margin-bottom: 1rem; color: var(--tx); }
    .popover-opts { display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 1rem; }
    .popover-opt {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.5rem 0.625rem; border-radius: 8px; cursor: pointer;
      font-size: 0.875rem;
    }
    .popover-opt:hover { background: var(--surface-2); }
    .popover-opt input[type="radio"] { accent-color: var(--accent); }
    .date-input-wrap { margin-top: 0.25rem; padding-left: 1.75rem; display: none; }
    .date-input-wrap.show { display: block; }
    .date-input {
      width: 100%; padding: 0.35rem 0.5rem;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 6px; color: var(--tx); font-size: 0.85rem; outline: none;
    }
    .date-input:focus { border-color: var(--accent); }
    .popover-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

    /* â”€â”€ Empty & loading states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--tx-dim); }
    .empty-state h3 { color: var(--tx); font-size: 1.1rem; margin-bottom: 0.5rem; }
    .loading { text-align: center; padding: 2.5rem 1rem; color: var(--tx-dim); font-size: 0.9rem; }

    /* â”€â”€ Season bulk actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bulk-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      #bottom-nav { display: flex; }
      .desktop-only { display: none !important; }
      #app { padding-bottom: 58px; }
      .page { padding: 1rem; }
      .show-hero { gap: 1rem; }
      .show-poster { width: 80px; }
      .show-title { font-size: 1.2rem; }
      .person-hero { gap: 1rem; }
      .person-photo, .person-photo-placeholder { width: 80px; height: 80px; }
      .person-name { font-size: 1.2rem; }
      .poster-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
      .nav-logo { font-size: 0.95rem; }
    }
    @media (min-width: 641px) {
      .mobile-only { display: none !important; }
    }
  </style>
</head>
<body>
  <nav id="top-nav"></nav>
  <div id="app"></div>
  <nav id="bottom-nav" class="bottom-nav"></nav>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const IMG = 'https://image.tmdb.org/t/p';
    const ACCENT = {
      schedule: 'var(--orange)',
      library:  'var(--yellow)',
      show:     'var(--blue)',
      season:   'var(--cyan)',
      episode:  'var(--green)',
      person:   'var(--purple)',
      add:      'var(--red)',
      settings: 'var(--red)',
    };
    const STATUS_LABEL = { airing: 'Airing Now', binging: 'Binging', caught_up: 'Caught Up', done: 'Done' };
    const STATUS_COLOR = { airing: 'var(--orange)', binging: 'var(--yellow)', caught_up: 'var(--cyan)', done: 'var(--muted)' };

    // â”€â”€ Router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function navigate(path) { history.pushState({}, '', path); render(); }
    window.addEventListener('popstate', render);

    function parseRoute(path) {
      const p = path.split('/').filter(Boolean);
      if (!p.length) return { page: 'schedule' };
      if (p[0] === 'library')  return { page: 'library' };
      if (p[0] === 'add')      return { page: 'add' };
      if (p[0] === 'settings') return { page: 'settings' };
      if (p[0] === 'person')   return { page: 'person', personId: p[1] };
      if (p[0] === 'show') {
        if (!p[1]) return { page: 'library' };
        if (p[2] === 'season' && p[4] === 'episode')
          return { page: 'episode', showId: p[1], season: +p[3], episode: +p[5] };
        if (p[2] === 'season')
          return { page: 'season', showId: p[1], season: +p[3] };
        return { page: 'show', showId: p[1] };
      }
      return { page: 'schedule' };
    }

    function setAccent(v) { document.documentElement.style.setProperty('--accent', v); }

    function render() {
      const r = parseRoute(location.pathname);
      buildNav(r.page);
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loading">Loadingâ€¦</div>';
      setAccent(ACCENT[r.page] || 'var(--red)');
      switch (r.page) {
        case 'schedule': pageSchedule(app); break;
        case 'library':  pageLibrary(app); break;
        case 'add':      pageAdd(app); break;
        case 'show':     pageShow(app, +r.showId); break;
        case 'season':   pageSeason(app, +r.showId, r.season); break;
        case 'episode':  pageEpisode(app, +r.showId, r.season, r.episode); break;
        case 'person':   pagePerson(app, +r.personId); break;
        case 'settings': pageSettings(app); break;
      }
    }

    // â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function api(method, path, body) {
      const r = await fetch(path, {
        method,
        headers: body ? { 'Content-Type': 'application/json' } : {},
        body: body ? JSON.stringify(body) : undefined,
      });
      if (!r.ok) { const t = await r.text(); throw new Error(t || r.statusText); }
      return r.json();
    }
    const get   = p       => api('GET', p);
    const post  = (p, b)  => api('POST', p, b);
    const patch = (p, b)  => api('PATCH', p, b);

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function esc(s) {
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function img(path, size) { return path ? `${IMG}/${size}${path}` : ''; }
    function pad2(n) { return String(n).padStart(2, '0'); }
    function epCode(s, e) { return `S${pad2(s)}E${pad2(e)}`; }
    function today() { return new Date().toISOString().slice(0, 10); }
    function yesterday() { return new Date(Date.now() - 86400000).toISOString().slice(0, 10); }

    // episodes: [{number: int, watched: bool}, ...]
    // Renders a flush segmented bar; container clips to border-radius.
    function segBarHTML(episodes) {
      if (!episodes.length) return '<div class="seg-bar"></div>';
      return '<div class="seg-bar">'
        + episodes.map(function(e) {
            return '<div class="seg' + (e.watched ? ' w' : '') + '" data-seg="' + e.number + '"></div>';
          }).join('')
        + '</div>';
    }

    // Attach click listeners to all [data-nav] elements within a root
    function bindNav(root) {
      (root || document).querySelectorAll('[data-nav]').forEach(el => {
        el.addEventListener('click', e => { e.preventDefault(); navigate(el.dataset.nav); });
      });
    }

    // â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildNav(page) {
      const top = document.getElementById('top-nav');
      const bot = document.getElementById('bottom-nav');
      top.innerHTML = `
        <div class="nav-bar">
          <a class="nav-logo" data-nav="/">WHIST</a>
          <div class="nav-links desktop-only">
            <a class="nav-link ${page==='schedule'?'active':''}" data-nav="/">Schedule</a>
            <a class="nav-link ${page==='library'?'active':''}" data-nav="/library">Library</a>
          </div>
          <div class="nav-spacer"></div>
          <a class="nav-icon" data-nav="/add" title="Add Show" style="font-size:1.3rem">+</a>
          <a class="nav-icon desktop-only" data-nav="/settings" title="Settings">âš™</a>
        </div>`;
      bot.innerHTML = `
        <a class="bottom-nav-item ${page==='schedule'?'active':''}" data-nav="/">
          <span class="bn-icon">ðŸ“…</span><span>Schedule</span>
        </a>
        <a class="bottom-nav-item ${page==='library'?'active':''}" data-nav="/library">
          <span class="bn-icon">ðŸŽ¬</span><span>Library</span>
        </a>
        <a class="bottom-nav-item ${page==='add'?'active':''}" data-nav="/add">
          <span class="bn-icon">+</span><span>Add</span>
        </a>
        <a class="bottom-nav-item ${page==='settings'?'active':''}" data-nav="/settings">
          <span class="bn-icon">âš™</span><span>Settings</span>
        </a>`;
      bindNav(top); bindNav(bot);
    }

    // â”€â”€ Cast grid component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function castGridHTML(cast, label) {
      if (!cast.length) return `<p style="color:var(--tx-dim);font-size:0.85rem">No cast data.</p>`;
      return `
        <div class="cast-section">
          ${label ? `<div class="cast-section-label">${esc(label)}</div>` : ''}
          <div class="cast-grid">
            ${cast.slice(0, 40).map(m => `
              <div class="cast-item" data-nav="/person/${m.person_tmdb_id}">
                <div class="cast-photo-wrap">
                  ${m.profile_path
                    ? `<img class="cast-photo" src="${img(m.profile_path,'w185')}" alt="${esc(m.name)}" loading="lazy">`
                    : `<div class="cast-photo-placeholder">ðŸ‘¤</div>`}
                  ${(m.seen_in_count > 0) ? `<div class="cast-badge">${m.seen_in_count}</div>` : ''}
                </div>
                <div class="cast-name">${esc(m.name)}</div>
                <div class="cast-char">${esc(m.character||'')}</div>
              </div>`).join('')}
          </div>
        </div>`;
    }

    // â”€â”€ Watch providers component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Normalize brand symbols so "Paramount+" and "Paramount Plus" compare equal.
    function _normProv(name) {
      return name
        .replace('Paramount+', 'Paramount Plus')
        .replace('Disney+', 'Disney Plus')
        .replace('Apple TV+', 'Apple TV Plus')
        .toLowerCase();
    }

    // True if providerName matches a saved service (exact or prefix match after normalizing).
    // e.g. savedSet has "Paramount+" â†’ matches "Paramount Plus Amazon Channel" too.
    function isPreferred(providerName, savedSet) {
      const n = _normProv(providerName);
      for (const s of savedSet) {
        const sn = _normProv(s);
        if (n === sn || n.startsWith(sn + ' ') || sn.startsWith(n + ' ')) return true;
      }
      return false;
    }

    function providerLogoHTML(p, savedSet) {
      const pref = isPreferred(p.provider_name, savedSet);
      return '<div class="provider-logo' + (pref ? ' provider-pref' : '') + '" title="' + esc(p.provider_name) + '">'
        + (p.logo_path
            ? '<img src="' + img(p.logo_path, 'w92') + '" alt="' + esc(p.provider_name) + '" loading="lazy">'
            : '<span>' + esc(p.provider_name.slice(0, 2)) + '</span>')
        + '</div>';
    }

    // Build one provider group (Stream or Rent).
    // If the user has preferences and some match: show preferred + "+N others" toggle.
    // Otherwise show all.
    function _providerGroupHTML(providers, label, savedSet) {
      if (!providers.length) return '';
      const pref  = providers.filter(p =>  isPreferred(p.provider_name, savedSet));
      const other = providers.filter(p => !isPreferred(p.provider_name, savedSet));
      const collapse = savedSet.size > 0 && pref.length > 0 && other.length > 0;

      let logos;
      if (collapse) {
        logos = pref.map(p => providerLogoHTML(p, savedSet)).join('');
        logos += '<button class="provider-toggle"'
          + " onclick=\"this.nextElementSibling.classList.add('open');this.hidden=true\""
          + '>+' + other.length + '</button>';
        logos += '<span class="provider-overflow">'
          + other.map(p => providerLogoHTML(p, savedSet)).join('')
          + '</span>';
      } else {
        logos = providers.map(p => providerLogoHTML(p, savedSet)).join('');
      }

      return '<div class="provider-group">'
        + '<span class="provider-label">' + label + '</span>'
        + '<div class="provider-logos">' + logos + '</div>'
        + '</div>';
    }

    function providerRowHTML(streaming, rent, savedSet) {
      if (!streaming.length && !rent.length) return '';
      return '<div class="provider-row">'
        + _providerGroupHTML(streaming, 'Stream', savedSet)
        + _providerGroupHTML(rent, 'Rent', savedSet)
        + '</div>';
    }

    // Shared helper: fetch and inject providers (non-blocking).
    // selector: CSS selector for the target element within app.
    // streamOnly: true = streaming logos only (compact), false = Stream + Rent groups.
    function loadProviders(app, tmdbId, selector, streamOnly) {
      const saved = JSON.parse(localStorage.getItem('whist_services') || '[]');
      const savedSet = new Set(saved);
      const sort = arr => [
        ...arr.filter(p =>  isPreferred(p.provider_name, savedSet)),
        ...arr.filter(p => !isPreferred(p.provider_name, savedSet)),
      ];
      get(`/shows/${tmdbId}/watch-providers`).then(prov => {
        const el = app.querySelector(selector);
        if (!el) return;
        if (streamOnly) {
          el.innerHTML = sort(prov.streaming).map(p => providerLogoHTML(p, savedSet)).join('');
        } else {
          el.innerHTML = providerRowHTML(sort(prov.streaming), sort(prov.rent), savedSet);
        }
      }).catch(() => {
        const el = app.querySelector(selector);
        if (el) el.remove();
      });
    }

    // â”€â”€ Date picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showDatePicker(titleStr, currentDate, onSave) {
      const tod = today(), yest = yesterday();
      let sel = 'today';
      if (!currentDate) sel = 'today';
      else if (currentDate === tod)  sel = 'today';
      else if (currentDate === yest) sel = 'yesterday';
      else sel = 'pick';

      const ov = document.createElement('div');
      ov.className = 'popover-overlay';
      ov.innerHTML = `
        <div class="popover">
          <h3>${esc(titleStr)}</h3>
          <div class="popover-opts">
            <label class="popover-opt">
              <input type="radio" name="dp" value="today" ${sel==='today'?'checked':''}> Today
            </label>
            <label class="popover-opt">
              <input type="radio" name="dp" value="yesterday" ${sel==='yesterday'?'checked':''}> Yesterday
            </label>
            <label class="popover-opt">
              <input type="radio" name="dp" value="pick" ${sel==='pick'?'checked':''}> Pick a dateâ€¦
            </label>
            <div class="date-input-wrap ${sel==='pick'?'show':''}">
              <input class="date-input" type="date" value="${sel==='pick'&&currentDate?currentDate:''}">
            </div>
            <label class="popover-opt">
              <input type="radio" name="dp" value="none"> No date
            </label>
          </div>
          <div class="popover-actions">
            <button class="btn btn-ghost btn-sm" id="_dp_cancel">Cancel</button>
            <button class="btn btn-accent btn-sm" id="_dp_save">Save</button>
          </div>
        </div>`;

      ov.querySelectorAll('input[name="dp"]').forEach(r => {
        r.addEventListener('change', () => {
          ov.querySelector('.date-input-wrap').classList.toggle('show', r.value === 'pick');
        });
      });
      ov.querySelector('#_dp_cancel').onclick = () => ov.remove();
      ov.querySelector('#_dp_save').onclick = () => {
        const v = ov.querySelector('input[name="dp"]:checked')?.value || 'today';
        let d = v === 'today' ? tod : v === 'yesterday' ? yest
              : v === 'pick' ? (ov.querySelector('.date-input').value || null)
              : null;
        ov.remove();
        onSave(d);
      };
      ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });
      document.body.appendChild(ov);
    }

    // â”€â”€ Poster card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function posterCardHTML(show) {
      const href = `/show/${show.tmdb_id}`;
      const pct = show.total_count > 0 ? Math.round(show.watched_count / show.total_count * 100) : 0;
      return `
        <div class="poster-card" data-nav="${href}">
          ${show.poster_path
            ? `<img src="${img(show.poster_path,'w300')}" alt="${esc(show.title)}" loading="lazy">`
            : `<div class="poster-placeholder">${esc(show.title)}</div>`}
          <div class="card-title">${esc(show.title)}</div>
          <div class="card-progress" data-seg-card="${show.tmdb_id}">
            <div class="card-progress-fill" style="width:${pct}%"></div>
          </div>
        </div>`;
    }

    // â”€â”€ Page: Schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageSchedule(app) {
      let data;
      try { data = await get('/schedule/today'); }
      catch(e) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Error loading schedule</h3><p>${esc(e.message)}</p></div></div>`;
        return;
      }

      const SECTION_LABEL = {
        airing_now:    'Airing Now',
        keep_watching: 'Keep Watching',
        up_next:       'Up Next',
        pick_up_again: 'Pick Up Again',
      };

      function schedCardHTML(item) {
        const { show, next_episode: ep, new_count } = item;
        const code = epCode(ep.season_number, ep.episode_number);
        const nav = `/show/${show.tmdb_id}/season/${ep.season_number}/episode/${ep.episode_number}`;
        const badge = new_count > 1 ? `<span class="sched-new-badge">${new_count} new</span>` : '';
        return `
          <div class="schedule-card" data-nav="${nav}" data-show-id="${show.tmdb_id}">
            ${show.poster_path
              ? `<img class="sched-poster" src="${img(show.poster_path,'w185')}" alt="${esc(show.title)}" loading="lazy">`
              : `<div class="sched-poster"></div>`}
            <div class="sched-info">
              <div class="sched-title-row">
                <span class="sched-title">${esc(show.title)}</span>
                ${badge}
              </div>
              <div class="sched-ep">${esc(code)}${ep.title ? ' Â· ' + esc(ep.title) : ''}</div>
              ${ep.air_date ? `<div class="sched-date">${esc(ep.air_date)}</div>` : ''}
              <div class="sched-providers"></div>
            </div>
          </div>`;
      }

      const order = ['airing_now', 'keep_watching', 'up_next', 'pick_up_again'];
      const sections = order.filter(k => data[k].length);

      let body;
      if (!sections.length) {
        body = `
          <div class="empty-state">
            <h3>Nothing queued up</h3>
            <p>Mark episodes watched or set shows to Airing/Binging to see suggestions here.</p>
            <button class="btn btn-accent" style="margin-top:1rem" data-nav="/library">Go to Library</button>
          </div>`;
      } else {
        body = sections.map(k => `
          <div class="schedule-section">
            <div class="section-header">
              <h2 style="color:var(--orange)">${SECTION_LABEL[k]}</h2>
              <span class="section-count">${data[k].length}</span>
            </div>
            <div class="schedule-list">${data[k].map(schedCardHTML).join('')}</div>
          </div>`).join('');
      }

      app.innerHTML = `
        <div class="page">
          <div class="page-header">
            <h1>Schedule</h1>
            <p>What to watch today</p>
          </div>
          ${body}
        </div>`;
      bindNav(app);

      // Load preferred streaming providers for each unique show (non-blocking).
      // On schedule cards only show services the user has saved â€” keeps cards clean.
      const saved = JSON.parse(localStorage.getItem('whist_services') || '[]');
      const savedSet = new Set(saved);
      const allItems = [
        ...data.airing_now, ...data.keep_watching, ...data.up_next, ...data.pick_up_again,
      ];
      const uniqueShowIds = [...new Set(allItems.map(item => item.show.tmdb_id))];
      uniqueShowIds.forEach(showId => {
        get(`/shows/${showId}/watch-providers`).then(prov => {
          // Filter to preferred services only (or all if no preferences set)
          const streaming = savedSet.size > 0
            ? prov.streaming.filter(p => isPreferred(p.provider_name, savedSet))
            : prov.streaming;
          if (!streaming.length) return;
          const html = streaming.map(p => providerLogoHTML(p, savedSet)).join('');
          app.querySelectorAll(`[data-show-id="${showId}"] .sched-providers`).forEach(el => {
            el.innerHTML = html;
          });
        }).catch(() => {});
      });
    }

    // â”€â”€ Page: Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageLibrary(app) {
      let shows;
      try { shows = await get('/shows'); }
      catch (e) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Error</h3><p>${esc(e.message)}</p></div></div>`;
        return;
      }

      const groups = { airing: [], binging: [], caught_up: [], done: [] };
      for (const s of shows) groups[s.user_status] ? groups[s.user_status].push(s) : groups.done.push(s);

      const order = ['airing', 'binging', 'caught_up', 'done'];
      const sectionColors = { airing: 'var(--orange)', binging: 'var(--yellow)', caught_up: 'var(--cyan)', done: 'var(--muted)' };

      let body = order.filter(k => groups[k].length).map(k => `
        <div class="section">
          <div class="section-header">
            <h2 style="color:${sectionColors[k]}">${STATUS_LABEL[k]}</h2>
            <span class="section-count">${groups[k].length}</span>
          </div>
          <div class="poster-grid">${groups[k].map(posterCardHTML).join('')}</div>
        </div>`).join('');

      if (!shows.length) body = `
        <div class="empty-state">
          <h3>No shows tracked yet</h3>
          <p>Add some shows to get started.</p>
          <button class="btn btn-accent" style="margin-top:1rem" data-nav="/add">+ Add Show</button>
        </div>`;

      app.innerHTML = `
        <div class="page">
          <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem">
            <div>
              <h1>My Library</h1>
              <p>${shows.length} show${shows.length!==1?'s':''} tracked</p>
            </div>
            <button class="btn btn-accent" data-nav="/add">+ Add Show</button>
          </div>
          ${body}
        </div>`;
      bindNav(app);

      // Upgrade poster card bars to segmented episode bars (non-blocking, one request per show).
      // Shows the solid percentage fill first, then replaces with detailed segments once loaded.
      shows.forEach(function(show) {
        get('/shows/' + show.tmdb_id + '/season-progress').then(function(seasons) {
          const el = app.querySelector('[data-seg-card="' + show.tmdb_id + '"]');
          if (!el) return;
          // Flatten all seasons; use sequential index so numbers don't repeat across seasons
          const episodes = seasons.flatMap(function(s) { return s.episodes; })
                                  .map(function(e, i) { return { number: i, watched: e.watched }; });
          if (episodes.length) el.innerHTML = segBarHTML(episodes);
        }).catch(function() {});
      });
    }

    // â”€â”€ Page: Add Show â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageAdd(app) {
      app.innerHTML = `
        <div class="page">
          <div class="page-header">
            <h1>Add Show</h1>
            <p>Search TMDB to track a show</p>
          </div>
          <input class="search-input" id="q" type="search" placeholder="Searchâ€¦" autocomplete="off">
          <div id="results"></div>
        </div>`;

      const input = app.querySelector('#q');
      const results = app.querySelector('#results');
      let debounce, trackedIds;

      get('/shows').then(s => { trackedIds = new Set(s.map(x => x.tmdb_id)); }).catch(() => { trackedIds = new Set(); });

      input.focus();
      input.addEventListener('input', () => {
        clearTimeout(debounce);
        const q = input.value.trim();
        if (!q) { results.innerHTML = ''; return; }
        debounce = setTimeout(async () => {
          results.innerHTML = '<div class="loading">Searchingâ€¦</div>';
          try {
            const res = await post('/shows/search', { query: q });
            if (!res.length) { results.innerHTML = '<div class="empty-state"><p>No results.</p></div>'; return; }
            results.innerHTML = `<div class="search-results">${res.map(r => `
              <div class="search-result" data-nav="/show/${r.tmdb_id}">
                ${r.poster_path
                  ? `<img class="search-result-poster" src="${img(r.poster_path,'w92')}" alt="${esc(r.title)}">`
                  : `<div class="search-result-poster"></div>`}
                <div class="search-result-info">
                  <div class="search-result-title">${esc(r.title)}</div>
                  <div class="search-result-meta">${r.first_air_date?r.first_air_date.slice(0,4):''}</div>
                  <div class="search-result-overview">${esc(r.overview)}</div>
                </div>
                ${trackedIds?.has(r.tmdb_id) ? '<span class="search-tracked">âœ“ Added</span>' : ''}
              </div>`).join('')}</div>`;
            bindNav(results);
          } catch(e) {
            results.innerHTML = `<div class="empty-state"><p>Search error: ${esc(e.message)}</p></div>`;
          }
        }, 300);
      });
      bindNav(app);
    }

    // â”€â”€ Page: Show â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageShow(app, tmdbId) {
      let [detailR, progressR] = await Promise.allSettled([
        get(`/shows/${tmdbId}/detail`),
        get(`/shows/${tmdbId}/progress`),
      ]);
      const detail = detailR.status === 'fulfilled' ? detailR.value : null;
      const progress = progressR.status === 'fulfilled' ? progressR.value : null;

      if (!detail) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Show not found</h3></div></div>`;
        return;
      }

      const years = detail.first_air_date
        ? (detail.last_air_date && detail.last_air_date !== detail.first_air_date
            ? `${detail.first_air_date}â€“${detail.last_air_date}` : detail.first_air_date)
        : '';

      const networks = detail.networks.slice(0,2).join(', ');
      const meta = [years, networks, detail.tmdb_status].filter(Boolean).join(' Â· ');

      const addBannerHTML = !detail.tracked ? `
        <div class="add-banner" id="add-banner">
          <h3>Add to Library</h3>
          <p>Choose a status to start tracking</p>
          <div class="add-status-row">
            ${Object.entries(STATUS_LABEL).map(([k,v]) =>
              `<button class="add-status-opt ${k==='airing'?'selected':''}" data-status="${k}">${v}</button>`
            ).join('')}
          </div>
          <button class="btn btn-accent" id="add-btn" style="margin-top:0.5rem">Add to Library</button>
        </div>` : '';

      const statusHTML = detail.tracked ? `
        <div class="status-selector">
          ${Object.entries(STATUS_LABEL).map(([k,v]) =>
            `<button class="status-btn ${detail.user_status===k?'active':''}" data-status="${k}">${v}</button>`
          ).join('')}
        </div>` : '';

      const progressHTML = progress ? `
        <div class="progress-row">${progress.watched} / ${progress.total} episodes (${progress.percent}%)</div>
        <div class="progress-bar" style="max-width:240px"><div class="progress-fill" style="width:${progress.percent}%"></div></div>` : '';

      const seasonsHTML = detail.seasons.map(s => `
        <div class="season-row" data-nav="/show/${tmdbId}/season/${s.season_number}">
          ${s.poster_path
            ? `<img class="season-thumb" src="${img(s.poster_path,'w185')}" alt="" loading="lazy">`
            : `<div class="season-thumb-placeholder">${s.season_number}</div>`}
          <div class="season-info">
            <div class="season-name">${esc(s.name||`Season ${s.season_number}`)}</div>
            <div class="season-meta">${s.air_date?s.air_date+' Â· ':''}${s.episode_count} ep</div>
            <div class="season-bar-wrap" data-season="${s.season_number}"></div>
          </div>
          <span class="season-chevron">â€º</span>
        </div>`).join('');

      app.innerHTML = `
        <div class="page">
          <div class="breadcrumb">
            <a data-nav="/library">Library</a>
          </div>
          ${addBannerHTML}
          ${detail.backdrop_path
            ? `<img class="show-backdrop" src="${img(detail.backdrop_path,'w1280')}" alt="" loading="lazy">`
            : ''}
          <div class="show-hero">
            ${detail.poster_path
              ? `<img class="show-poster" src="${img(detail.poster_path,'w300')}" alt="${esc(detail.title)}">`
              : ''}
            <div class="show-info">
              <h1 class="show-title">${esc(detail.title)}</h1>
              <div class="show-meta">${esc(meta)}</div>
              ${statusHTML}
              ${progressHTML}
              <div id="watch-providers"></div>
              <p class="show-overview">${esc(detail.overview||'')}</p>
            </div>
          </div>
          <div class="section" style="margin-top:1.75rem">
            <div class="section-header"><h2>Cast</h2></div>
            <div id="cast-pane"><div class="loading" style="padding:0.5rem 0;text-align:left;font-size:0.85rem">Loading castâ€¦</div></div>
          </div>
          <div class="section">
            <div class="section-header"><h2>Seasons</h2></div>
            <div class="season-list">${seasonsHTML}</div>
          </div>
        </div>`;

      bindNav(app);

      // Load season progress bars (non-blocking)
      get(`/shows/${tmdbId}/season-progress`).then(function(seasons) {
        seasons.forEach(function(s) {
          const wrap = app.querySelector('.season-bar-wrap[data-season="' + s.season_number + '"]');
          if (wrap) wrap.outerHTML = segBarHTML(s.episodes);
        });
      }).catch(function() {});

      // Load cast (non-blocking)
      get(`/shows/${tmdbId}/cast`).then(cast => {
        const pane = app.querySelector('#cast-pane');
        if (!pane) return;
        pane.innerHTML = castGridHTML(cast);
        bindNav(pane);
      }).catch(() => {
        const pane = app.querySelector('#cast-pane');
        if (pane) pane.innerHTML = '';
      });

      // Status buttons
      app.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await patch(`/shows/${tmdbId}/status`, { user_status: btn.dataset.status });
            app.querySelectorAll('.status-btn').forEach(b =>
              b.classList.toggle('active', b.dataset.status === btn.dataset.status));
          } catch(e) { alert('Error: ' + e.message); }
        });
      });

      // Add banner
      if (!detail.tracked) {
        let selStatus = 'airing';
        app.querySelectorAll('.add-status-opt').forEach(o => {
          o.addEventListener('click', () => {
            selStatus = o.dataset.status;
            app.querySelectorAll('.add-status-opt').forEach(x => x.classList.toggle('selected', x===o));
          });
        });
        app.querySelector('#add-btn')?.addEventListener('click', async () => {
          try {
            await post('/shows/add', { tmdb_id: tmdbId, user_status: selStatus });
            navigate(`/show/${tmdbId}`);
          } catch(e) { alert('Error: ' + e.message); }
        });
      }

      // Load watch providers (non-blocking)
      loadProviders(app, tmdbId, '#watch-providers', false);
    }

    // â”€â”€ Page: Season â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageSeason(app, tmdbId, seasonNum) {
      let data;
      try { data = await get(`/shows/${tmdbId}/season/${seasonNum}`); }
      catch(e) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Error</h3><p>${esc(e.message)}</p></div></div>`;
        return;
      }

      // Local mutable state so we can update rows without full re-fetch
      const epState = {};
      data.episodes.forEach(ep => { epState[ep.episode_number] = { watched: ep.watched, watched_at: ep.watched_at, title: ep.title }; });

      const watched = data.episodes.filter(e => e.watched).length;
      const total = data.episodes.length;

      function epRowHTML(ep) {
        const st = epState[ep.episode_number];
        return `
          <div class="episode-row" data-ep="${ep.episode_number}">
            <div class="ep-check ${st.watched?'watched':''}" data-check="${ep.episode_number}">${st.watched?'âœ“':''}</div>
            <div class="ep-info">
              <div class="ep-code">${epCode(seasonNum, ep.episode_number)}</div>
              <div class="ep-title">${esc(ep.title||'')}</div>
            </div>
            ${ep.air_date?`<div class="ep-air-date">${ep.air_date}</div>`:''}
            ${st.watched&&st.watched_at?`<div class="ep-watched-at">${st.watched_at}</div>`:''}
            <button class="ep-edit-btn" data-edit="${ep.episode_number}" title="${st.watched?'Edit date':'Log with date'}">âœ</button>
          </div>`;
      }

      const headerSegBar = segBarHTML(data.episodes.map(function(e) {
        return { number: e.episode_number, watched: e.watched };
      }));

      app.innerHTML = `
        <div class="page">
          <div class="breadcrumb">
            <a data-nav="/library">Library</a>
            <span class="breadcrumb-sep">â€º</span>
            <a data-nav="/show/${tmdbId}" id="show-crumb">Show</a>
            <span class="breadcrumb-sep">â€º</span>
            <span>${esc(data.name||`Season ${seasonNum}`)}</span>
          </div>
          <div style="display:flex;gap:1.25rem;align-items:flex-start;margin-bottom:1.5rem">
            ${data.poster_path
              ? `<img src="${img(data.poster_path,'w185')}" style="width:72px;border-radius:7px;flex-shrink:0" alt="" loading="lazy">`
              : ''}
            <div>
              <h1 style="font-size:1.4rem;font-weight:700;color:var(--accent);margin-bottom:0.2rem">${esc(data.name||`Season ${seasonNum}`)}</h1>
              <div style="color:var(--tx-dim);font-size:0.82rem">${data.air_date?data.air_date+' Â· ':''}${total} episodes</div>
              <div class="progress-row" style="margin-top:0.5rem" id="prog-text">${watched} / ${total} watched</div>
              <div id="prog-bar" style="max-width:220px;margin-top:0.3rem">${headerSegBar}</div>
              <div id="season-providers"></div>
            </div>
          </div>
          <div class="bulk-actions">
            <button class="btn btn-outline btn-sm" id="mark-all">Mark Season Watched</button>
          </div>
          <div class="episode-list" id="ep-list">
            ${data.episodes.map(epRowHTML).join('')}
          </div>
        </div>`;

      bindNav(app);

      // Update breadcrumb show name
      get(`/shows/${tmdbId}/detail`).then(d => {
        const el = app.querySelector('#show-crumb');
        if (el) el.textContent = d.title;
      }).catch(()=>{});

      // Load watch providers (non-blocking)
      loadProviders(app, tmdbId, '#season-providers', false);

      function updateProgress() {
        const w = Object.values(epState).filter(s => s.watched).length;
        const pt = app.querySelector('#prog-text');
        if (pt) pt.textContent = `${w} / ${total} watched`;
      }

      function updateRow(epNum) {
        const st = epState[epNum];
        const row = app.querySelector(`[data-ep="${epNum}"]`);
        if (!row) return;
        const check = row.querySelector('[data-check]');
        if (st.watched) { check.classList.add('watched'); check.textContent = 'âœ“'; }
        else { check.classList.remove('watched'); check.textContent = ''; }
        // Update watched_at
        const old = row.querySelector('.ep-watched-at');
        if (old) old.remove();
        if (st.watched && st.watched_at) {
          const d = document.createElement('div');
          d.className = 'ep-watched-at'; d.textContent = st.watched_at;
          row.querySelector('.ep-edit-btn').before(d);
        }
        // Update header bar segment
        const seg = app.querySelector('#prog-bar .seg[data-seg="' + epNum + '"]');
        if (seg) seg.classList.toggle('w', st.watched);
      }

      // Episode list events
      app.querySelector('#ep-list').addEventListener('click', async e => {
        const check = e.target.closest('[data-check]');
        const editBtn = e.target.closest('[data-edit]');
        const row = e.target.closest('.episode-row');

        if (row && !check && !editBtn) {
          navigate(`/show/${tmdbId}/season/${seasonNum}/episode/${+row.dataset.ep}`);
          return;
        }

        if (check) {
          const epNum = +check.dataset.check;
          const newWatched = !epState[epNum].watched;
          const prevState = { ...epState[epNum] };
          epState[epNum] = { ...epState[epNum], watched: newWatched, watched_at: newWatched ? today() : null };
          updateRow(epNum); updateProgress();
          try {
            await post('/episodes/watched', {
              tmdb_show_id: tmdbId, season_number: seasonNum,
              episode_number: epNum, watched: newWatched, watched_at: 'today',
            });
          } catch(err) {
            epState[epNum] = prevState; updateRow(epNum); updateProgress();
            alert('Error: ' + err.message);
          }
        }

        if (editBtn) {
          const epNum = +editBtn.dataset.edit;
          const st = epState[epNum];
          showDatePicker(st.title || `Episode ${epNum}`, st.watched_at, async d => {
            try {
              await post('/episodes/watched', {
                tmdb_show_id: tmdbId, season_number: seasonNum,
                episode_number: epNum, watched: true, watched_at: d,
              });
              epState[epNum] = { ...epState[epNum], watched: true, watched_at: d };
              updateRow(epNum); updateProgress();
            } catch(err) { alert('Error: ' + err.message); }
          });
        }
      });

      // Mark all watched
      app.querySelector('#mark-all').addEventListener('click', async () => {
        try {
          await post('/episodes/watched/bulk', { tmdb_show_id: tmdbId, season_number: seasonNum, watched_at: 'today' });
          const tod = today();
          data.episodes.forEach(ep => { epState[ep.episode_number] = { ...epState[ep.episode_number], watched: true, watched_at: tod }; });
          data.episodes.forEach(ep => updateRow(ep.episode_number));
          updateProgress();
        } catch(e) { alert('Error: ' + e.message); }
      });
    }

    // â”€â”€ Page: Episode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pageEpisode(app, tmdbId, seasonNum, epNum) {
      let seasonData;
      try { seasonData = await get(`/shows/${tmdbId}/season/${seasonNum}`); }
      catch(e) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Error</h3><p>${esc(e.message)}</p></div></div>`;
        return;
      }

      const ep = seasonData.episodes.find(e => e.episode_number === epNum);
      if (!ep) {
        app.innerHTML = `<div class="page"><div class="empty-state"><h3>Episode not found</h3></div></div>`;
        return;
      }

      function rerender() { pageEpisode(app, tmdbId, seasonNum, epNum); }

      app.innerHTML = `
        <div class="page">
          <div class="breadcrumb">
            <a data-nav="/library">Library</a>
            <span class="breadcrumb-sep">â€º</span>
            <a data-nav="/show/${tmdbId}" id="show-crumb">Show</a>
            <span class="breadcrumb-sep">â€º</span>
            <a data-nav="/show/${tmdbId}/season/${seasonNum}">${esc(seasonData.name||`Season ${seasonNum}`)}</a>
            <span class="breadcrumb-sep">â€º</span>
            <span>${epCode(seasonNum, epNum)}</span>
          </div>
          ${ep.still_path
            ? `<img class="ep-still" src="${img(ep.still_path,'w780')}" alt="" loading="lazy">`
            : ''}
          <h1 style="font-size:1.3rem;font-weight:700;color:var(--accent);margin-bottom:0.2rem">${esc(ep.title||`Episode ${epNum}`)}</h1>
          <div style="color:var(--tx-dim);font-size:0.82rem;margin-bottom:1.25rem">
            ${epCode(seasonNum, epNum)}${ep.air_date?' Â· '+ep.air_date:''}
          </div>
          <div class="ep-watch-row" id="watch-row">
            ${ep.watched
              ? `<span style="color:var(--accent);font-size:0.9rem">âœ“ Watched${ep.watched_at?' Â· '+ep.watched_at:''}</span>
                 <button class="btn btn-ghost btn-sm" id="ep-edit-date">âœ Edit date</button>
                 <button class="btn btn-ghost btn-sm" id="ep-unwatch" style="color:var(--tx-dim)">Unwatch</button>`
              : `<button class="btn btn-accent" id="ep-watch">Mark Watched</button>
                 <button class="btn btn-outline btn-sm" id="ep-watch-date">Log with date</button>`}
          </div>
          <div id="ep-providers"></div>
          ${ep.overview?`<p style="color:var(--tx-dim);line-height:1.7;margin-bottom:2rem">${esc(ep.overview)}</p>`:''}
          <div id="ep-cast-section"><div class="loading" style="padding:1rem 0;text-align:left">Loading castâ€¦</div></div>
        </div>`;

      bindNav(app);

      get(`/shows/${tmdbId}/detail`).then(d => {
        const el = app.querySelector('#show-crumb'); if (el) el.textContent = d.title;
      }).catch(()=>{});

      // Load watch providers (non-blocking)
      loadProviders(app, tmdbId, '#ep-providers', false);

      app.querySelector('#ep-watch')?.addEventListener('click', async () => {
        await post('/episodes/watched', { tmdb_show_id: tmdbId, season_number: seasonNum, episode_number: epNum, watched: true, watched_at: 'today' });
        rerender();
      });
      app.querySelector('#ep-watch-date')?.addEventListener('click', () => {
        showDatePicker(ep.title||`Episode ${epNum}`, null, async d => {
          await post('/episodes/watched', { tmdb_show_id: tmdbId, season_number: seasonNum, episode_number: epNum, watched: true, watched_at: d });
          rerender();
        });
      });
      app.querySelector('#ep-edit-date')?.addEventListener('click', () => {
        showDatePicker(ep.title||`Episode ${epNum}`, ep.watched_at, async d => {
          await post('/episodes/watched', { tmdb_show_id: tmdbId, season_number: seasonNum, episode_number: epNum, watched: true, watched_at: d });
          rerender();
        });
      });
      app.querySelector('#ep-unwatch')?.addEventListener('click', async () => {
        await post('/episodes/watched', { tmdb_show_id: tmdbId, season_number: seasonNum, episode_number: epNum, watched: false });
        rerender();
      });

      // Load episode cast (non-blocking)
      get(`/shows/${tmdbId}/season/${seasonNum}/episode/${epNum}/cast`).then(castData => {
        const section = app.querySelector('#ep-cast-section');
        if (!section) return;
        let html = '';
        if (castData.cast.length) html += castGridHTML(castData.cast, 'Cast');
        if (castData.guest_stars.length) html += castGridHTML(castData.guest_stars, 'Guest Stars');
        section.innerHTML = html || '';
        if (html) bindNav(section);
      }).catch(() => {
        const section = app.querySelector('#ep-cast-section');
        if (section) section.innerHTML = '';
      });
    }

    // â”€â”€ Page: Person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pagePerson(app, tmdbId) {
      let data;
      try { data = await get(`/people/${tmdbId}/seen-in`); }
      catch(e) {
        app.innerHTML = `
          <div class="page">
            <div class="empty-state">
              <h3>Person not cached</h3>
              <p>Open a show's Cast tab to load this person first.</p>
              <button class="btn btn-ghost" style="margin-top:1rem" onclick="history.back()">â† Go Back</button>
            </div>
          </div>`;
        return;
      }

      const { person, seen_in } = data;

      const seenHTML = seen_in.length ? `
        <div class="seen-in-section">
          <div class="seen-in-label">Seen in ${seen_in.length} title${seen_in.length!==1?'s':''} you've watched</div>
          <div class="seen-in-grid">
            ${seen_in.map(c => `
              <div class="seen-in-card" data-nav="/show/${c.tmdb_id}">
                ${c.poster_path
                  ? `<img src="${img(c.poster_path,'w185')}" alt="${esc(c.title)}" loading="lazy">`
                  : `<div class="seen-in-card-placeholder">${esc(c.title)}</div>`}
                <div class="seen-in-title">${esc(c.title)}</div>
                <div class="seen-in-char">${esc(c.character||'')}</div>
              </div>`).join('')}
          </div>
        </div>` : `
        <div style="background:var(--surface);border-radius:10px;padding:1rem;margin-bottom:2rem;color:var(--tx-dim);font-size:0.875rem">
          No overlap with your watch history yet.
        </div>`;

      app.innerHTML = `
        <div class="page">
          <div class="person-hero">
            ${person.profile_path
              ? `<img class="person-photo" src="${img(person.profile_path,'w185')}" alt="${esc(person.name)}">`
              : `<div class="person-photo-placeholder">ðŸ‘¤</div>`}
            <div>
              <h1 class="person-name">${esc(person.name)}</h1>
            </div>
          </div>
          ${seenHTML}
          <div class="section-header">
            <h2>All Credits</h2>
            <span class="section-count" id="credits-count">â€¦</span>
          </div>
          <div id="all-credits"><div class="loading">Loadingâ€¦</div></div>
        </div>`;

      bindNav(app);

      // Load all credits
      const seenIds = new Set(seen_in.map(c => c.tmdb_id));
      try {
        const credits = await get(`/people/${tmdbId}/all-credits`);
        app.querySelector('#credits-count').textContent = credits.length;
        if (!credits.length) {
          app.querySelector('#all-credits').innerHTML = '<p style="color:var(--tx-dim)">No credits cached.</p>';
        } else {
          app.querySelector('#all-credits').innerHTML = `
            <div class="credits-list">
              ${credits.map(c => `
                <div class="credit-row" data-nav="/show/${c.show_tmdb_id}">
                  ${c.poster_path
                    ? `<img class="credit-poster" src="${img(c.poster_path,'w92')}" alt="${esc(c.title)}" loading="lazy">`
                    : `<div class="credit-poster-ph"></div>`}
                  <div class="credit-info">
                    <div class="credit-title">${esc(c.title)}</div>
                    <div class="credit-char">${esc(c.character||'')}${c.type?' Â· '+c.type:''}</div>
                  </div>
                  ${seenIds.has(c.show_tmdb_id)?'<div class="credit-dot" title="In your watch history"></div>':''}
                </div>`).join('')}
            </div>`;
          bindNav(app.querySelector('#all-credits'));
        }
      } catch(e) {
        app.querySelector('#all-credits').innerHTML = `<p style="color:var(--tx-dim)">Could not load credits.</p>`;
      }
    }

    // â”€â”€ Page: Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function pageSettings(app) {
      const services = ['Netflix','Hulu','Max','Apple TV+','Peacock','Paramount+','Disney+','Prime Video','Tubi','Crunchyroll','Shudder','MUBI'];
      const saved = JSON.parse(localStorage.getItem('whist_services')||'[]');

      app.innerHTML = `
        <div class="page">
          <div class="page-header"><h1>Settings</h1></div>
          <div style="max-width:440px">
            <div style="background:var(--surface);border-radius:12px;padding:1.25rem">
              <h2 style="font-size:1rem;margin-bottom:0.25rem">My Streaming Services</h2>
              <p style="font-size:0.82rem;color:var(--tx-dim);margin-bottom:1rem">Preferred services appear first; others are hidden behind a toggle.</p>
              <div id="svc-list" style="display:flex;flex-direction:column;gap:0.25rem">
                ${services.map(s => `
                  <label style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem;border-radius:8px;cursor:pointer">
                    <input type="checkbox" value="${esc(s)}" ${saved.includes(s)?'checked':''} style="accent-color:var(--accent);width:16px;height:16px">
                    <span>${esc(s)}</span>
                  </label>`).join('')}
              </div>
              <button class="btn btn-accent" style="margin-top:1rem;width:100%" id="save-btn">Save Preferences</button>
            </div>
          </div>
        </div>`;

      app.querySelector('#save-btn').addEventListener('click', () => {
        const checked = [...app.querySelectorAll('#svc-list input:checked')].map(i => i.value);
        localStorage.setItem('whist_services', JSON.stringify(checked));
        const btn = app.querySelector('#save-btn');
        btn.textContent = 'Saved âœ“';
        setTimeout(() => { btn.textContent = 'Save Preferences'; }, 1500);
      });
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    render();
  </script>
</body>
</html>
